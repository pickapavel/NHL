<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="UTF-8">
<title>Import statistik ze zápasu (OCR)</title>

<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>

<style>
body{margin:0;font-family:Arial;background:#f2f2f2}
.wrapper{max-width:1200px;margin:0 auto;background:white;padding:30px}
table{border-collapse:collapse;width:100%;margin-top:20px}
th,td{border:1px solid #999;padding:6px 8px;text-align:center}
th{background:#cfe8f7}
.left{text-align:left}
.upload{margin:20px 0;padding:20px;border:2px dashed #22a6df;text-align:center}
button{padding:6px 10px}

.dialog{
display:none;
position:fixed;
left:50%;
top:50%;
transform:translate(-50%,-50%);
background:white;
padding:20px;
border:2px solid #333;
z-index:999;
}
</style>
</head>

<body>

<div class="wrapper">

<h1>Import statistik ze zápasu (OCR)</h1>

<div class="upload">
<input type="file" id="img" accept="image/*">
<p>Po nahrání obrázku se statistiky zapíšou do tabulky a zůstanou i po F5.</p>
</div>

<table id="statsTable">
<thead>
<tr>
<th>Tým</th>
<th>Role</th>
<th>Góly vstř.</th>
<th>Góly ink.</th>
<th>Hity dané</th>
<th>Hity obdrž.</th>
<th>Vhaz. vyhr.</th>
<th>Vhaz. prohr.</th>
<th>Čas v útoku</th>
<th>Čas v obraně</th>
<th>Přesilovky</th>
<th>Využ. PP</th>
<th>OT</th>
<th>Kategorie</th>
<th>Hráč</th>
<th>Akce</th>
</tr>
</thead>
<tbody></tbody>
</table>

</div>

<!-- DIALOG -->
<div id="editDialog" class="dialog">
<h3>Aktualizace zápasu</h3>

Kategorie:<br>
<select id="dlgKategorie">
<option>OH</option>
<option>Extraliga - základní část</option>
<option>Extraliga - play off</option>
</select><br><br>

Tým:<br>
<select id="dlgTeam"></select><br><br>

Hráč:<br>
<select id="dlgHrac">
<option>Pici</option>
<option>Kubele</option>
</select><br><br>

<button onclick="saveEdit()">Uložit</button>
<button onclick="closeDialog()">Zrušit</button>
</div>

<script>

let allRows=[];
let editMatchStart=null;

/* ===== LOCAL STORAGE ===== */

function saveLocal(){
localStorage.setItem("ocr_stats",JSON.stringify(allRows));
}

function loadLocal(){
const data=localStorage.getItem("ocr_stats");
if(!data) return;
allRows=JSON.parse(data);
renderTable();
}

/* ===== TABULKA ===== */

function renderTable(){

const tbody=document.querySelector("#statsTable tbody");
tbody.innerHTML="";

for(let i=0;i<allRows.length;i+=2){

const r1=allRows[i];
const r2=allRows[i+1];

const tr1=document.createElement("tr");
const tr2=document.createElement("tr");

tr1.innerHTML=
r1.data.map((c,j)=>"<td class='"+(j==0?"left":"")+"'>"+c+"</td>").join("")+
"<td>"+(r1.kategorie||"")+"</td>"+
"<td>"+(r1.hrac||"")+"</td>"+
"<td rowspan='2'><button onclick='openDialog("+i+")'>Aktualizovat</button></td>";

tr2.innerHTML=
r2.data.map((c,j)=>"<td class='"+(j==0?"left":"")+"'>"+c+"</td>").join("")+
"<td>"+(r2.kategorie||"")+"</td>"+
"<td>"+(r2.hrac||"")+"</td>";

tbody.appendChild(tr1);
tbody.appendChild(tr2);
}
}

/* ===== DIALOG ===== */

function openDialog(index){

editMatchStart=index;

const teamSelect=document.getElementById("dlgTeam");
teamSelect.innerHTML="";

teamSelect.innerHTML=
"<option>"+allRows[index].data[0]+"</option>"+
"<option>"+allRows[index+1].data[0]+"</option>";

document.getElementById("editDialog").style.display="block";
}

function closeDialog(){
document.getElementById("editDialog").style.display="none";
}

function saveEdit(){

const kat=document.getElementById("dlgKategorie").value;
const team=document.getElementById("dlgTeam").value;
const hrac=document.getElementById("dlgHrac").value;
const druhy=(hrac==="Pici")?"Kubele":"Pici";

allRows[editMatchStart].kategorie=kat;
allRows[editMatchStart+1].kategorie=kat;

if(allRows[editMatchStart].data[0]===team){
allRows[editMatchStart].hrac=hrac;
allRows[editMatchStart+1].hrac=druhy;
}else{
allRows[editMatchStart].hrac=druhy;
allRows[editMatchStart+1].hrac=hrac;
}

saveLocal();
renderTable();
closeDialog();
}

/* ===== OCR ===== */

function findLine(text, keyword){
return text.split("\n").find(l=>l.includes(keyword))||"";
}
function numbers(line){
return line.match(/[0-9:]+/g)||[];
}

document.getElementById("img").addEventListener("change",async(e)=>{

const file=e.target.files[0];
if(!file) return;

const result=await Tesseract.recognize(file,'eng');
const text=result.data.text.toUpperCase();

const shots=numbers(findLine(text,"SHOTS"));
const hits=numbers(findLine(text,"HITS"));
const faceoffs=numbers(findLine(text,"FACEOFF"));
const attack=numbers(findLine(text,"TIMEONATTACK"));
const pp=numbers(findLine(text,"PP"));

const awayRow=[
"HC Geus Okna Kladno","Hosté",
shots[0],shots[1],
hits[0],hits[1],
faceoffs[0],faceoffs[1],
attack[0],attack[1],
pp[0],pp[0],"Ne"
];

const homeRow=[
"HC Oceláři Třinec","Domácí",
shots[1],shots[0],
hits[1],hits[0],
faceoffs[1],faceoffs[0],
attack[1],attack[0],
pp[1],pp[1],"Ne"
];

allRows.push({data:awayRow});
allRows.push({data:homeRow});

saveLocal();
renderTable();
});

loadLocal();

</script>
</body>
</html>
