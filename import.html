<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="UTF-8">
<title>Import statistik ze zĂˇpasu (OCR)</title>

<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>

<style>
body{margin:0;font-family:Arial;background:#f2f2f2}
.wrapper{max-width:1200px;margin:0 auto;background:white;padding:30px}
table{border-collapse:collapse;width:100%;margin-top:20px}
th,td{border:1px solid #999;padding:6px 8px;text-align:center}
th{background:#cfe8f7}
.left{text-align:left}
.upload{margin:20px 0;padding:20px;border:2px dashed #22a6df;text-align:center}
.filters{margin:10px 0;padding:10px;background:#eef6fb}
button{padding:6px 10px}
dialog{padding:20px}
.summary{margin-top:10px;font-weight:bold}
</style>
</head>

<body>
<div class="wrapper">

<h1>Import statistik ze zĂˇpasu (OCR)</h1>

<!-- NOVĂť DROPDOWN PRO VĂťBÄšR TĂťMU -->
<div class="filters">
<strong>Vybrat tĂ˝m (zobrazĂ­ vĹˇechny jeho zĂˇpasy):</strong>
<select id="filterTeamMain">
<option value="">VĹˇechny tĂ˝my</option>
</select>
</div>

<div class="upload">
<input type="file" id="img" accept="image/*">
</div>

<div class="filters">
HrĂˇÄŤ:
<select id="filterPlayer">
<option value="">VĹˇe</option>
<option>Pici</option>
<option>Kubele</option>
</select>

TĂ˝m:
<select id="filterTeam"><option value="">VĹˇe</option></select>

Kategorie:
<select id="filterCategory">
<option value="">VĹˇe</option>
<option>OH</option>
<option>Extraliga - zĂˇkladnĂ­ ÄŤĂˇst</option>
<option>Extraliga - play off</option>
</select>
</div>

<table id="statsTable">
<thead>
<tr>
<th>TĂ˝m</th>
<th>Role</th>
<th>GĂłly vstĹ™.</th>
<th>GĂłly ink.</th>
<th>Hity danĂ©</th>
<th>Hity obdrĹľ.</th>
<th>Vhaz. vyhr.</th>
<th>Vhaz. prohr.</th>
<th>ÄŚas v Ăştoku</th>
<th>ÄŚas v obranÄ›</th>
<th>PĹ™esilovky</th>
<th>VyuĹľ. PP</th>
<th>OT</th>
<th>Kategorie</th>
<th>HrĂˇÄŤ</th>
<th>Akce</th>
</tr>
</thead>
<tbody></tbody>
</table>

<div class="summary" id="summary"></div>

</div>

<dialog id="editDialog">
<h3>Aktualizace zĂˇpasu</h3>

Kategorie:<br>
<select id="dlgCategory">
<option>OH</option>
<option>Extraliga - zĂˇkladnĂ­ ÄŤĂˇst</option>
<option>Extraliga - play off</option>
</select><br><br>

TĂ˝m (hrĂˇÄŤ):<br>
<select id="dlgPlayer">
<option>Kubele</option>
<option>Pici</option>
</select><br><br>

<button onclick="saveEdit()">UloĹľit</button>
<button onclick="editDialog.close()">ZavĹ™Ă­t</button>
</dialog>

<script>

let allMatches=[];
let editIndex=null;

function saveLocal(){
localStorage.setItem("ocr_matches",JSON.stringify(allMatches));
}

function loadLocal(){
const data=localStorage.getItem("ocr_matches");
if(data) allMatches=JSON.parse(data);
renderTable();
}

function renderTable(){

const tbody=document.querySelector("#statsTable tbody");
tbody.innerHTML="";

allMatches.forEach((m,i)=>{

const tr1=document.createElement("tr");
const tr2=document.createElement("tr");

tr1.innerHTML=
m.away.map((c,j)=>"<td class='"+(j==0?"left":"")+"'>"+c+"</td>").join("")+
"<td>"+(m.category||"")+"</td>"+
"<td>"+(m.playerAway||"")+"</td>"+
"<td rowspan='2'><button onclick='openDialog("+i+")'>Aktualizovat</button></td>";

tr2.innerHTML=
m.home.map((c,j)=>"<td class='"+(j==0?"left":"")+"'>"+c+"</td>").join("")+
"<td>"+(m.category||"")+"</td>"+
"<td>"+(m.playerHome||"")+"</td>";

tbody.appendChild(tr1);
tbody.appendChild(tr2);
});

fillTeams();
applyFilters();
}

function openDialog(i){
editIndex=i;
editDialog.showModal();
}

function saveEdit(){

const cat=dlgCategory.value;
const player=dlgPlayer.value;
const other=player==="Pici"?"Kubele":"Pici";

allMatches[editIndex].category=cat;
allMatches[editIndex].playerAway=player;
allMatches[editIndex].playerHome=other;

saveLocal();
renderTable();
editDialog.close();
}

/* OCR */

function findLine(t,k){return t.split("\n").find(l=>l.includes(k))||"";}
function numbers(l){return l.match(/[0-9:]+/g)||[];}

document.getElementById("img").addEventListener("change",async e=>{

const file=e.target.files[0];
if(!file) return;

const r=await Tesseract.recognize(file,'eng');
const text=r.data.text.toUpperCase();

const shots=numbers(findLine(text,"SHOTS"));
const hits=numbers(findLine(text,"HITS"));
const faceoffs=numbers(findLine(text,"FACEOFF"));
const attack=numbers(findLine(text,"TIMEONATTACK"));
const pp=numbers(findLine(text,"PP"));

const away=["HC Geus Okna Kladno","HostĂ©",shots[0],shots[1],hits[0],hits[1],faceoffs[0],faceoffs[1],attack[0],attack[1],pp[0],pp[0],"Ne"];
const home=["HC OcelĂˇĹ™i TĹ™inec","DomĂˇcĂ­",shots[1],shots[0],hits[1],hits[0],faceoffs[1],faceoffs[0],attack[1],attack[0],pp[1],pp[1],"Ne"];

allMatches.push({away:away,home:home});

saveLocal();
renderTable();
});

/* FILTRY */

function fillTeams(){

const sel=document.getElementById("filterTeam");
const selMain=document.getElementById("filterTeamMain");

const set=new Set();
allMatches.forEach(m=>{
set.add(m.away[0]);
set.add(m.home[0]);
});

sel.innerHTML='<option value="">VĹˇe</option>';
selMain.innerHTML='<option value="">VĹˇechny tĂ˝my</option>';

set.forEach(t=>{
const o=document.createElement("option");
o.textContent=t;
sel.appendChild(o);

const o2=document.createElement("option");
o2.textContent=t;
selMain.appendChild(o2);
});
}

function applyFilters(){

const p=filterPlayer.value;
const t=filterTeam.value;
const c=filterCategory.value;
const mainTeam=document.getElementById("filterTeamMain").value;

const rows=document.querySelectorAll("#statsTable tbody tr");

let games=0;

for(let i=0;i<rows.length;i+=2){

const r1=rows[i];
const r2=rows[i+1];

const player=r1.cells[14].innerText;
const team1=r1.cells[0].innerText;
const team2=r2.cells[0].innerText;
const cat=r1.cells[13].innerText;

let show=true;

if(mainTeam && team1!==mainTeam && team2!==mainTeam) show=false;
if(p && player!==p) show=false;
if(t && team1!==t) show=false;
if(c && cat!==c) show=false;

r1.style.display=show?"":"none";
r2.style.display=show?"":"none";

if(show) games++;
}

summary.innerText="ZĂˇpasy: "+games;
}

filterPlayer.onchange=applyFilters;
filterTeam.onchange=applyFilters;
filterCategory.onchange=applyFilters;
filterTeamMain.onchange=applyFilters;

loadLocal();

</script>
</body>
</html>
