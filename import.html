<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="UTF-8">
<title>Import statistik ze zápasu (OCR)</title>

<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>

<style>
body{margin:0;font-family:Arial;background:#f2f2f2}
.wrapper{max-width:1200px;margin:0 auto;background:white;padding:30px}
table{border-collapse:collapse;width:100%;margin-top:20px}
th,td{border:1px solid #999;padding:6px 8px;text-align:center}
th{background:#cfe8f7}
.left{text-align:left}
.upload{margin:20px 0;padding:20px;border:2px dashed #22a6df;text-align:center}
.filters{margin:10px 0;padding:10px;background:#eef6fb}
button{padding:6px 10px}
dialog{padding:20px}
.summary{margin-top:10px;font-weight:bold}
h2{margin-top:40px}
</style>
</head>

<body>
<div class="wrapper">

<h1>Import statistik ze zápasu (OCR)</h1>

<div class="upload">
<input type="file" id="img" accept="image/*">
</div>

<div class="filters">
Hráč:
<select id="filterPlayer">
<option value="">Vše</option>
<option>Pici</option>
<option>Kubele</option>
</select>

Tým:
<select id="filterTeam"><option value="">Vše</option></select>

Kategorie:
<select id="filterCategory">
<option value="">Vše</option>
<option>OH</option>
<option>Extraliga - základní část</option>
<option>Extraliga - play off</option>
</select>
</div>

<table id="statsTable">
<thead>
<tr>
<th>Tým</th>
<th>Role</th>
<th>Góly vstř.</th>
<th>Góly ink.</th>
<th>Hity dané</th>
<th>Hity obdrž.</th>
<th>Vhaz. vyhr.</th>
<th>Vhaz. prohr.</th>
<th>Čas v útoku</th>
<th>Čas v obraně</th>
<th>Přesilovky</th>
<th>Využ. PP</th>
<th>OT</th>
<th>Kategorie</th>
<th>Hráč</th>
<th>Akce</th>
</tr>
</thead>
<tbody></tbody>
</table>

<div class="summary" id="summary"></div>

<h2>Souhrn statistik (kontingenční pohled)</h2>

<table id="pivotTable">
<thead>
<tr>
<th>Tým</th>
<th>Zápasy</th>
<th>Góly</th>
<th>Inkas.</th>
<th>Hity</th>
<th>Obdrž.</th>
<th>Vhaz.</th>
<th>Prohr.</th>
<th>Čas útok</th>
<th>Čas obrana</th>
<th>PP</th>
<th>PP góly</th>
<th>PP %</th>
</tr>
</thead>
<tbody></tbody>
</table>

</div>

<script>

let allMatches=[];
let editIndex=null;

function saveLocal(){
localStorage.setItem("ocr_matches",JSON.stringify(allMatches));
}

function loadLocal(){
const data=localStorage.getItem("ocr_matches");
if(data) allMatches=JSON.parse(data);
renderTable();
}

function renderTable(){

const tbody=document.querySelector("#statsTable tbody");
tbody.innerHTML="";

allMatches.forEach((m,i)=>{

const tr1=document.createElement("tr");
const tr2=document.createElement("tr");

tr1.innerHTML=
m.away.map((c,j)=>"<td class='"+(j==0?"left":"")+"'>"+c+"</td>").join("")+
"<td>"+(m.category||"")+"</td>"+
"<td>"+(m.playerAway||"")+"</td>"+
"<td rowspan='2'><button onclick='openDialog("+i+")'>Aktualizovat</button></td>";

tr2.innerHTML=
m.home.map((c,j)=>"<td class='"+(j==0?"left":"")+"'>"+c+"</td>").join("")+
"<td>"+(m.category||"")+"</td>"+
"<td>"+(m.playerHome||"")+"</td>";

tbody.appendChild(tr1);
tbody.appendChild(tr2);
});

fillTeams();
applyFilters();
buildPivot();
}

function timeToSec(t){
if(!t || !t.includes(":")) return 0;
const p=t.split(":");
return parseInt(p[0])*60+parseInt(p[1]);
}

function secToTime(s){
const m=Math.floor(s/60);
const sec=s%60;
return m+":"+(sec<10?"0":"")+sec;
}

function buildPivot(){

const tbody=document.querySelector("#pivotTable tbody");
tbody.innerHTML="";

const p=filterPlayer.value;
const t=filterTeam.value;
const c=filterCategory.value;

let stats={};

allMatches.forEach(m=>{

[m.away,m.home].forEach((row,i)=>{

const team=row[0];
const player=i==0?m.playerAway:m.playerHome;
const cat=m.category;

if(p && player!==p) return;
if(t && team!==t) return;
if(c && cat!==c) return;

if(!stats[team]){
stats[team]={
games:0,g:0,ga:0,h:0,ha:0,
fo:0,fol:0,toa:0,tod:0,pp:0,ppg:0
};
}

stats[team].games++;
stats[team].g+=parseInt(row[2]||0);
stats[team].ga+=parseInt(row[3]||0);
stats[team].h+=parseInt(row[4]||0);
stats[team].ha+=parseInt(row[5]||0);
stats[team].fo+=parseInt(row[6]||0);
stats[team].fol+=parseInt(row[7]||0);
stats[team].toa+=timeToSec(row[8]);
stats[team].tod+=timeToSec(row[9]);
stats[team].pp+=parseInt(row[10]||0);
stats[team].ppg+=parseInt(row[11]||0);

});

});

Object.keys(stats).forEach(team=>{

const s=stats[team];
const tr=document.createElement("tr");

const ppPerc=s.pp?Math.round((s.ppg/s.pp)*100):0;

tr.innerHTML=
`<td class="left">${team}</td>
<td>${s.games}</td>
<td>${s.g}</td>
<td>${s.ga}</td>
<td>${s.h}</td>
<td>${s.ha}</td>
<td>${s.fo}</td>
<td>${s.fol}</td>
<td>${secToTime(s.toa)}</td>
<td>${secToTime(s.tod)}</td>
<td>${s.pp}</td>
<td>${s.ppg}</td>
<td>${ppPerc}%</td>`;

tbody.appendChild(tr);
});

}

function fillTeams(){
const sel=document.getElementById("filterTeam");
const set=new Set();
allMatches.forEach(m=>{set.add(m.away[0]);set.add(m.home[0]);});
sel.innerHTML='<option value="">Vše</option>';
set.forEach(t=>{
const o=document.createElement("option");
o.textContent=t;
sel.appendChild(o);
});
}

function applyFilters(){

const p=filterPlayer.value;
const t=filterTeam.value;
const c=filterCategory.value;

const rows=document.querySelectorAll("#statsTable tbody tr");

let games=0;

for(let i=0;i<rows.length;i+=2){

const r1=rows[i];
const r2=rows[i+1];

const player=r1.cells[14].innerText;
const team=r1.cells[0].innerText;
const cat=r1.cells[13].innerText;

let show=true;

if(p && player!==p) show=false;
if(t && team!==t) show=false;
if(c && cat!==c) show=false;

r1.style.display=show?"":"none";
r2.style.display=show?"":"none";

if(show) games++;
}

summary.innerText="Zápasy: "+games;
buildPivot();
}

filterPlayer.onchange=applyFilters;
filterTeam.onchange=applyFilters;
filterCategory.onchange=applyFilters;

loadLocal();

</script>
</body>
</html>
