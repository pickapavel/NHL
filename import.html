<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="UTF-8">
<title>Import statistik ze zápasu (OCR)</title>

<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>

<!-- FIREBASE (doplníš svoje údaje) -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

<style>
body{margin:0;font-family:Arial;background:#f2f2f2}
.wrapper{max-width:1200px;margin:0 auto;background:white;padding:30px}
table{border-collapse:collapse;width:100%;margin-top:20px}
th,td{border:1px solid #999;padding:6px 8px;text-align:center}
th{background:#cfe8f7}
.left{text-align:left}
.upload{margin:20px 0;padding:20px;border:2px dashed #22a6df;text-align:center}
button{padding:8px 14px;margin-top:10px}
</style>
</head>
<body>

<div class="wrapper">
<h1>Import statistik ze zápasu (OCR)</h1>

<div class="upload">
<input type="file" id="img" accept="image/*">
<p>Po nahrání obrázku se statistiky uloží do Firebase a zároveň do XML.</p>
</div>

<button onclick="downloadXML()">Stáhnout XML</button>

<table id="statsTable">
<thead>
<tr>
<th>Tým</th>
<th>Role</th>
<th>Góly vstř.</th>
<th>Góly ink.</th>
<th>Hity dané</th>
<th>Hity obdrž.</th>
<th>Vhaz. vyhr.</th>
<th>Vhaz. prohr.</th>
<th>Čas v útoku</th>
<th>Čas v obraně</th>
<th>Přesilovky</th>
<th>Využ. PP</th>
<th>OT</th>
</tr>
</thead>
<tbody></tbody>
</table>

</div>

<script>


// Your web app's Firebase configuration
const firebaseConfig = {
  apiKey: "AIzaSyD0jDnVNHAzs83g6FGwQT_nQpOCvI4NTNU",
  authDomain: "statistiky-6310a.firebaseapp.com",
  projectId: "statistiky-6310a",
  storageBucket: "statistiky-6310a.firebasestorage.app",
  messagingSenderId: "1023222901562",
  appId: "1:1023222901562:web:522ee763e27aa08a8b7e03"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();
/* ============================================ */

const TEAM_MAP = {
  "KLA": "HC Geus Okna Kladno",
  "TRI": "HC Oceláři Třinec",
  "SPA": "HC Sparta Praha",
  "LIT": "HC Litvínov"
};

let xmlData = [];

function addRow(data){
  const tr=document.createElement("tr");
  tr.innerHTML=data.map((c,i)=>"<td class='"+(i==0?"left":"")+"'>"+c+"</td>").join("");
  document.querySelector("#statsTable tbody").appendChild(tr);
}

function findLine(text, keyword){
  return text.split("\n").find(l => l.includes(keyword)) || "";
}

function numbers(line){
  return line.match(/[0-9:]+/g) || [];
}

document.getElementById("img").addEventListener("change", async (e)=>{

  const file = e.target.files[0];
  if(!file) return;

  const result = await Tesseract.recognize(file,'eng');
  const text = result.data.text.toUpperCase();

  let away="Hosté";
  let home="Domácí";

  Object.keys(TEAM_MAP).forEach(code=>{
    if(text.includes(code)){
      if(away==="Hosté") away=TEAM_MAP[code];
      else if(home==="Domácí") home=TEAM_MAP[code];
    }
  });

  const shots=numbers(findLine(text,"SHOTS"));
  const hits=numbers(findLine(text,"HITS"));
  const faceoffs=numbers(findLine(text,"FACEOFF"));
  const attack=numbers(findLine(text,"TIMEONATTACK"));
  const pp=numbers(findLine(text,"PP"));

  const awayRow=[away,"Hosté",shots[0],shots[1],hits[0],hits[1],faceoffs[0],faceoffs[1],attack[0],attack[1],pp[0],pp[0],"Ne"];
  const homeRow=[home,"Domácí",shots[1],shots[0],hits[1],hits[0],faceoffs[1],faceoffs[0],attack[1],attack[0],pp[1],pp[1],"Ne"];

  addRow(awayRow);
  addRow(homeRow);

  /* ULOŽENÍ DO FIREBASE */
  db.ref("ocr_statistiky").push({
    away: awayRow,
    home: homeRow,
    time: Date.now()
  });

  /* ULOŽENÍ DO XML PAMĚTI */
  xmlData.push({away:awayRow,home:homeRow});

  alert("Uloženo do Firebase + připraveno do XML.");
});

function downloadXML(){
  let xml = '<?xml version="1.0" encoding="UTF-8"?><zapasy>';
  xmlData.forEach(z=>{
    xml += "<zapas>";
    xml += "<hoste>"+z.away.join("|")+"</hoste>";
    xml += "<domaci>"+z.home.join("|")+"</domaci>";
    xml += "</zapas>";
  });
  xml += "</zapasy>";

  const blob = new Blob([xml],{type:"text/xml"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download="statistiky.xml";
  a.click();
}

</script>

</body>
</html>
