<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="UTF-8">
<title>Import statistik ze zápasu (OCR)</title>

<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>

<style>
body{margin:0;font-family:Arial;background:#f2f2f2}
.wrapper{max-width:1200px;margin:0 auto;background:white;padding:30px}
table{border-collapse:collapse;width:100%;margin-top:20px}
th,td{border:1px solid #999;padding:6px 8px;text-align:center}
th{background:#cfe8f7}
.left{text-align:left}
.upload{margin:20px 0;padding:20px;border:2px dashed #22a6df;text-align:center}
button{padding:8px 14px;margin-top:10px}
</style>
</head>

<body>

<div class="wrapper">

<h1>Import statistik ze zápasu (OCR)</h1>

<div class="upload">
<input type="file" id="img" accept="image/*">
<p>Po nahrání obrázku se statistiky zapíšou do tabulky a zůstanou i po F5.</p>
</div>

<table id="statsTable">
<thead>
<tr>
<th>Tým</th>
<th>Role</th>
<th>Góly vstř.</th>
<th>Góly ink.</th>
<th>Hity dané</th>
<th>Hity obdrž.</th>
<th>Vhaz. vyhr.</th>
<th>Vhaz. prohr.</th>
<th>Čas v útoku</th>
<th>Čas v obraně</th>
<th>Přesilovky</th>
<th>Využ. PP</th>
<th>OT</th>
</tr>
</thead>
<tbody></tbody>
</table>

</div>

<script>

/* ===== MAPA TÝMŮ ===== */

const TEAM_MAP = {
  "SPA": "HC Sparta Praha",
  "LIB": "HC Bílí Tygři Liberec",
  "KLA": "HC Geus Okna Kladno",
  "TRI": "HC Oceláři Třinec",
  "LIT": "HC Litvínov"
};

/* ===== TABULKA ===== */

function addRow(data){
  const tr=document.createElement("tr");
  tr.innerHTML=data.map((c,i)=>
    "<td class='"+(i==0?"left":"")+"'>"+c+"</td>"
  ).join("");
  document.querySelector("#statsTable tbody").appendChild(tr);
}

/* ===== LOCAL STORAGE ===== */

function saveTable(){
  localStorage.setItem(
    "ocr_stats",
    document.querySelector("#statsTable tbody").innerHTML
  );
}

function loadTable(){
  const data = localStorage.getItem("ocr_stats");
  if(data){
    document.querySelector("#statsTable tbody").innerHTML=data;
  }
}

loadTable();

/* ===== OCR POMOCNÉ ===== */

function findLine(text, keyword){
  return text.split("\n").find(l => l.includes(keyword)) || "";
}

function numbers(line){
  return line.match(/[0-9]+:[0-9]+|[0-9]+/g) || [];
}

/* ===== OCR ===== */

document.getElementById("img").addEventListener("change", async (e)=>{

  const file=e.target.files[0];
  if(!file) return;

  const result=await Tesseract.recognize(file,'eng');
  const text=result.data.text.toUpperCase();

  console.log(text);

  /* ---- TÝMY ---- */

  let teamsFound=[];

  Object.keys(TEAM_MAP).forEach(code=>{
    if(text.includes(code)){
      teamsFound.push(TEAM_MAP[code]);
    }
  });

  if(teamsFound.length<2){
    alert("Nepodařilo se rozpoznat oba týmy.");
    return;
  }

  const away=teamsFound[0];
  const home=teamsFound[1];

  /* ---- STATISTIKY ---- */

  const shots=numbers(findLine(text,"SHOTS"));
  const hits=numbers(findLine(text,"HITS"));
  const faceoffs=numbers(findLine(text,"FACEOFF"));
  const attack=numbers(findLine(text,"TIME ON ATTACK"));
  const pp=numbers(findLine(text," PP "));

  const awayRow=[
    away,"Hosté",
    shots[0],shots[1],
    hits[0],hits[1],
    faceoffs[0],faceoffs[1],
    attack[0],attack[1],
    pp[0],pp[1],
    "Ne"
  ];

  const homeRow=[
    home,"Domácí",
    shots[1],shots[0],
    hits[1],hits[0],
    faceoffs[1],faceoffs[0],
    attack[1],attack[0],
    pp[1],pp[0],
    "Ne"
  ];

  addRow(awayRow);
  addRow(homeRow);

  saveTable();

  alert("Zápas zapsán.");

});

</script>

</body>
</html>
